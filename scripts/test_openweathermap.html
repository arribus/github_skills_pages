<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Test OpenWeatherMap Widget</title>
  </head>
  <body>
    <h1>OpenWeatherMap test</h1>
    <p>
      <label for="apiKey">OpenWeatherMap API key:</label>
      <input id="apiKey" placeholder="Insert your API key here" />
    </p>
    <p>
      <label for="city">City:</label>
      <input id="city" placeholder="Insert a city" />
      <label for="country">Country code (optional):</label>
      <input id="country" placeholder="e.g. FR" style="width:4em" />
      <button id="fetch-weather">Get weather</button>
    </p>

    <div id="weather-output" aria-live="polite"></div>

    <script>
      (function () {
        const apiKeyInput = document.getElementById('apiKey');
        const cityInput = document.getElementById('city');
        const fetchBtn = document.getElementById('fetch-weather');
        const outputElement = document.getElementById('weather-output');

        async function fetchWeather() {
          const apiKey = apiKeyInput.value.trim();
          const city = cityInput.value.trim();

          if (!apiKey) {
            outputElement.textContent = 'Please provide an OpenWeatherMap API key.';
            return;
          }
          if (!city) {
            outputElement.textContent = 'Please enter a city name.';
            return;
          }

          const apiUrl = `https://api.openweathermap.org/data/2.5/weather?q=${encodeURIComponent(city)}&appid=${encodeURIComponent(apiKey)}&units=metric`;

          outputElement.textContent = 'Loading...';

          try {
            const response = await fetch(apiUrl);
            if (!response.ok) {
              if (response.status === 404) {
                outputElement.textContent = 'City not found. Please check the name.';
              } else {
                outputElement.textContent = `Error: ${response.status} ${response.statusText}`;
              }
              return;
            }

            const data = await response.json();
            const temperature = data.main?.temp;
            const description = data.weather?.[0]?.description;
            const location = data.name;

            // Build the human output
            let html = `<p>Temperature in ${location}: ${temperature}Â°C</p>` +
                       `<p>Weather: ${description}</p>`;

            // Additional metadata to help debug location mismatch
            const coord = data.coord;
            const cityId = data.id;
            const country = data.sys?.country;
            const dt = data.dt; // unix time (UTC)
            const tz = data.timezone; // shift in seconds from UTC

            html += `<p>Location: ${location}${country ? (', ' + country) : ''} (id: ${cityId})</p>`;
            if (coord) html += `<p>Coordinates: ${coord.lat}, ${coord.lon}</p>`;
            if (typeof dt === 'number') {
              // Show UTC and local time at the location (approx)
              const utc = new Date(dt * 1000).toISOString();
              const localAtLocation = new Date((dt + (tz || 0)) * 1000).toISOString();
              html += `<p>Timestamp (UTC): ${utc}</p>` +
                      `<p>Timestamp (local at location): ${localAtLocation} (tz offset: ${tz || 0}s)</p>`;
            }

            outputElement.innerHTML = html + '\n<details><summary>Raw API response (click to expand)</summary><pre id="raw-json" style="max-height:400px;overflow:auto;background:#f6f8fa;padding:8px;border-radius:4px"></pre></details>';
            const rawPre = document.getElementById('raw-json');
            rawPre.textContent = JSON.stringify(data, null, 2);
          } catch (err) {
            console.error(err);
            outputElement.textContent = 'Network error, see console for details.';
          }
        }

        fetchBtn.addEventListener('click', fetchWeather);
        cityInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') fetchWeather(); });
      })();
    </script>
  </body>
</html>